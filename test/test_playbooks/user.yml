---
- hosts: fixtures
  gather_facts: false
  tasks:
  - name: Load server config
    include_vars:
      file: server_vars.yml
  - include_tasks: tasks/location.yml
    vars:
      location_state: "present"
  - include_tasks: tasks/organization.yml
    vars:
      organization_state: "present"

- hosts: tests
  gather_facts: false
  environment:
    XDG_CACHE_HOME: "{{ lookup('env', 'FAM_TEST_APYPIE_CACHE_DIR') }}"
  tasks:
  - name: Load server config
    include_vars:
      file: server_vars.yml

  - include: tasks/user.yml
    vars:
      user_state: present
      user_password: s3cret
      expected_change: true

  - include: tasks/user.yml
    vars:
      user_state: present
      expected_change: false

  - include: tasks/user.yml
    vars:
      user_state: present
      user_locale: "{{ omit }}"
      user_mail: "{{ omit }}"
      user_description: A great manager
      expected_change: true

  # try to auth as new user
  - include: tasks/user.yml
    vars:
      foreman_username: test
      foreman_password: s3cret
      user_state: present
      user_mail: "{{ omit }}"
      expected_change: true

  - include: tasks/user.yml
    vars:
      user_state: present
      user_password: newp@ass
      user_mail: "{{ omit }}"
      expected_change: true

  # try to auth as new user with new password
  - include: tasks/user.yml
    vars:
      foreman_username: test
      foreman_password: newp@ass
      user_state: present
      user_mail: test.user@example.com
      expected_change: true

  - include: tasks/user.yml
    vars:
      user_state: absent
      expected_change: true
  - include: tasks/user.yml
    vars:
      user_state: absent
      expected_change: false

- hosts: fixtures
  gather_facts: false
  tasks:
  - name: Load server config
    include_vars:
      file: server_vars.yml
  - include_tasks: tasks/location.yml
    vars:
      location_state: "absent"
  - include_tasks: tasks/organization.yml
    vars:
      organization_state: "absent"

...
